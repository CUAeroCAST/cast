function [r] = cw_2nd_order(r0,n,R,t)
%CW2NDORDER Calculates spacecraft relitive motion using 2nd or CW terms
%   This function calculates a spacecrafts relitive position to a target
%   vehicle, given an initial position and velocity in the CW frame, using
%   second order terms
%   Source: https://etd.auburn.edu/bitstream/handle/10415/4566/Shubham_Garg_Thesis.pdf?isAllowed=y&sequence=2
% Inputs:
% [r0]: deputy initial state vector, n: chief mean motion, R, chief orbit radius, t: time
% Outputs:
% [r]: deputy final state
x0 = r0(1);
y0 = r0(2);
z0 = r0(3);
u0 = r0(4);
v0 = r0(5);
w0 = r0(6);
x = (4-3*cos(n*t))*x0+(1/n)*sin(n*t)*u0+(2/n)*(1-cos(n*t))*v0+...
    (3/(2*R))*(7-10*cos(n*t)+3*cos(2*n*t)+12*n*t*sin(n*t)-12*n^2*t^2)*(x0^2)+ ...
    (3/(2*R))*(1-cos(n*t))*y0^2+(1/(4*R))*(3-2*cos(n*t)-cos(2*n*t))*z0^2+...
    (1/(2*n^2*R))*(-3+4*cos(n*t)-cos(2*n*t))*u0^2+...
    (1/(2*n^2*R))*(6-10*cos(n*t)+4*cos(2*n*t)+12*n*t*sin(n*t)-9*n^2*t^2)*v0^2+...
    (1/(4*n^2*R))*(3-4*cos(n*t)+cos(2*n*t))*w0^2+(6/R)*(-sin(n*t)+n*t)*x0*y0+...
    (3/(n*R))*(4*sin(n*t)-sin(2*n*t)-4*n*t+2*n*t*cos(n*t))*x0*u0+...
    (3/(n*R))*(4-6*cos(n*t)+2*cos(2*n*t)+7*n*t*sin(n*t)-6*n^2*t^2)*x0*v0+...
    (3/(n*R))*(-sin(n*t)+(n*t))*y0*v0+(1/(2*n*R))*(2*sin(n*t)-sin(2*n*t))*z0*w0+...
    (1/(n^2*R))*(7*sin(n*t)-2*sin(2*n*t)-6*n*t+3*n*t*cos(n*t))*u0*v0;
y = 6*(sin(n*t)-n*t)*x0+y0+(2/n)*(-1+cos(n*t))*u0+(1/n)*(4*sin(n*t)-3*n*t)*v0+...
    (3/(4*R))*(40*sin(n*t)+3*sin(2*n*t)-22*n*t-24*n*t*cos(n*t))*x0^2+...
    (3/R)*(sin(n*t)-n*t)*y0^2 +(1/(4*R))*(4*sin(n*t)+sin(2*n*t)-6*n*t)*z0^2+...
    (1/(4*n^2*R))*(8*sin(n*t)-sin(2*n*t)-6*n*t)*u0^2+...
    (1/(n^2*R))*(10*sin(n*t)+sin(2*n*t)-6*n*t-6*n*t*cos(n*t))*v0^2+...
    (1/(4*n^2*R))*(8*sin(n*t)-sin(2*n*t)-6*n*t)*w0^2+(3/R)*(1-cos(n*t))*x0*y0+...
    (3/(2*n*R))*(-5*4*cos(n*t)+cos(2*n*t)+4*n*t*sin(n*t))*x0*u0+...
    (3/(n*R))*(12*sin(n*t)+sin(2*n*t)-7*n*t-7*n*t*cos(n*t))*x0*v0+...
    (3/(n*R))*(-sin(n*t)+n*t)*y0*u0+(1/(2*n*R))*(-3+4*cos(n*t)-cos(2*n*t))*z0*w0+...
    (1/(n^2*R))*(-3+2*cos(n*t)+cos(2*n*t)+3*n*t*sin(n*t))*u0*v0;
z = cos(n*t)*z0+((1/n)*sin(n*t))*w0+...
    ((3/(2*R))*(-3+2*cos(n*t)+cos(2*n*t)+4*n*t*sin(n*t)))*x0*z0+...
    (3/(2*n*R))*(2*sin(n*t)+sin(2*n*t)-4*n*t*cos(n*t))*x0*w0+...
    (1/(2*n*R))*(2*sin(n*t)-sin(2*n*t))*z0*u0+...
    (1/(n*R))*(-3+2*cos(n*t)+cos(2*n*t)+3*n*t*sin(n*t))*z0*v0+...
    (1/(2*n^2*R))*(3-4*cos(n*t)+cos(2*n*t))*u0*w0+...
    (1/(n^2*R))*(sin(n*t)+sin(2*n*t)-3*n*t*cos(n*t))*v0*w0;
r = [x,y,z];  
end

